#!/bin/bash
#
# create summarys of your computations 
#
# version history:
#
# version 0.1: (19.01.2018) 
# Tizian MÃ¼ller: 
# - basic stuff with gaussian .out-Files
# script is not fully tested. Use at your own risk
# please report any bugs and suggestions via mail or during cigarette breaks
#




# difine variables
VERSION="0.1"
USERFILEPATH=`whoami`
DIR=`pwd`
HOST=`ident_host | awk '{print $1}'`
HOSTIP=`ident_host | awk '{print $2}'`
#default settings: these may be changed by some arguments
CSVFILEFILEPATH="summary.csv"
CSVFILEFILEPATH_BKUP="summary_bkup.csv"
CSVDELIM=";"
DECISEP="."
SCRIPTDIR=`dirname $(readlink -f ${0})`
MAXFILES=25 # maximal files summary will read without extra user input
DEPTH=all #depth of search -1=all 0=current n=n subfolders
VERBOSITY=0 # verbosity of the output on terminal




function prnt_error {
echo -e  "\033[0;31m ERROR ! stopping script \033[0m "
}

function prnt_warning {
echo -e "\033[1;33m WARNING ! \033[0m "
}

function prnt_ok {
echo -e -n "\033[0;32m OK: \033[0m "
}

## here schould be some sort of check for arguments

while getopts ":hd:s:cn:v" OPTION; do
  case $OPTION in
    h) 
	vim $SCRIPTDIR/help_summary.txt  
	exit
	;;
	d)
	CSVDELIM=$OPTARG
	;;
	s)
	DECISEP=$OPTARG
	;;
	c)
	DEPTH=0
	;;
	n)
	DEPTH=$OPTARG
	;;
	v)
	VERBOSITY=1
	;;
    \?)
	prnt_error
    echo "Invalid option: -$OPTARG" >&2
	echo "For Help type: sumary -h"
	exit
    ;;
  esac
done



# show welcome message
echo -n "summary version $VERSION    "


#Defining the depth of search
case $DEPTH in
	all)
	LIST=`find ! -name 'slurm*.out' -name "*.out"`
	echo "... searching in all subfolders"
	;;
	0)
	LIST=`find -maxdepth 1 ! -name 'slurm*.out' -name "*.out"`
	echo "... searching in only the currend folder"
	;;
	*)
	echo "... searching this and $DEPTH subfolders"
	DEPTH=`echo "$DEPTH + 1"  | bc`
	LIST=`find -maxdepth $DEPTH ! -name 'slurm*.out' -name "*.out"`
	;;
esac

LISTARR=($LIST)


# asks for user reply if too much files are found

if [ ${#LISTARR[@]} -gt $MAXFILES ]
then
	prnt_warning
	echo "found a large amount of OUT files"
	echo "${#LISTARR[@]} / $MAXFILES"
	read -p "Do you want to proceed ? " -n 1 -r 
		case $REPLY in
        [Yy]* ) echo "  OK";;
        [Nn]* ) echo ""; exit;;
        * ) echo "  Please answer Y or N."; exit ;;
        esac
else echo "found ${#LISTARR[@]} OUT files ... starting now"
fi


######################################################
#            Functions for reading various stuff

function format_strings { # formats stuff like the full path to the file, the dir in which the file is stored and the filename
FILENAME=`echo " $FILEPATH" | sed -e 's@\/@ @g' | awk '{print $NF}'`
FILENAMFORMATTED=`echo "$FILENAME" | cut -c -24 `

FULLPATH=$FILEPATH 
}

function ident_prog { # identify the programm (gaussian, orca, ...) that created this OUT file
#orca:
FILEHEAD=`head -3 $FILEPATH `
IDENTORCA=`echo "$FILEHEAD"| grep -c "        * O   R   C   A *"`
IDENTGAUSSIAN=`echo "$FILEHEAD"| grep -c " Entering Gaussian System, Link 0"`

PROGID=0
PROGNAME="none"

if [ "$IDENTORCA" = "0" ] & [ "$IDENTGAUSSIAN" = "1" ]
	then
	PROGNAME="Gaussian"
fi 

if [ "$IDENTORCA" = "1" ] & [ "$IDENTGAUSSIAN" = "0" ]
	then
	PROGNAME="ORCA"
	NOTES+="ORCA_not_fully_implemented"
fi
}

function find_methode { # gives the used Method
if [ $PROGNAME = "Gaussian" ]
	then
	RAW=`grep -m 1 "GINC-" $FILEPATH | sed -e 's.\\\. .g'`
	METH=` echo $RAW | awk '{print $5}'`
	BASIS=`echo $RAW | awk '{print $6}'`
fi

}

function find_energ { 

if [ $PROGNAME = "Gaussian" ]
	then
	ENERG_EL=`tac $FILEPATH | grep -m 1 "SCF Done:  " | awk '{print $5}'`
fi

if [ $PROGNAME = "ORCA" ]
	then
	ENERG_EL=`grep "FINAL SINGLE POINT ENERGY" $FILEPATH | awk '{print $5}'`
fi

}

function find_ther_corr { # finds the themal corrections for electronic Energy
 
 
if [ $PROGNAME = "Gaussian" ]
then
TEST=`grep -c -i "Zero-point correction=" $FILEPATH `
	if [ "$TEST" != "0" ]
	then
	ZPVE=`grep "Zero-point correction=" $FILEPATH | awk '{print $3}'`
	RAW=`grep -A 8 "Zero-point correction=" $FILEPATH| awk 'NF>1{print $NF}'`
	RAWARRAY=($RAW)
 
	ENERG_THERM=${RAWARRAY[1]}
	ENTHALPY=${RAWARRAY[2]}
	GIBBS=${RAWARRAY[3]}
	fi
fi

}

function find_Nimag {

if [ $PROGNAME = "Gaussian" ]
then
TEST=`grep -i -m 1 "imaginary frequencies (negative Signs" $FILEPATH`
	if [ -z "$TEST" ]
	then 
	IMAG="0"
	else 
	IMAG=`grep -i -m 1 "imaginary frequencies (negative Signs" $FILEPATH | awk '{print $2}'`
	fi
fi
#then IMAG="0"
	#else IMAG="`grep -i -m 1 "imaginary frequencies (negative Signs" $FILEPATH | awk '{print $2}'`"

}

function find_NTerm {

if [ $PROGNAME = "Gaussian" ]
then
	NTERM=`grep -c "Normal termination of Gaussian" $FILEPATH`
fi

}

function find_version {

if [ $PROGNAME = "Gaussian" ]
then
	RAW=`grep -m 1 -A 2 "Cite this work as:" $FILEPATH`
	PROG=`echo $RAW | awk '{print $5 $6}' | sed 's/,//g'`
	REV=`echo $RAW | awk '{print $8}' | sed 's/,//g'`
fi
}

function find_runtime {

if [ "$PROGNAME" = "Gaussian" ]
	then
	TEMP=`tail -n 7 $FILEPATH `
	RUNTIME=`echo "$TEMP" | grep " Job cpu time:" | awk '{print $4":"$6":"$8":" $10}'`
	
	NT=`echo "$TEMP" | grep -c "Normal termination of Gaussian" `
	ET=`echo "$TEMP" | grep -c "Error termination request processed"`
	
	if [ "$NT" = "1" ]
		then
		JOBSTATE="F-NT"
		elif [ "$ET" = "1" ]
		then
		JOBSTATE="F-ET"
		NOTES+=" Error_termination"
		else
		JOBSTATE="unknown"
		NOTES+=" Job_running_or_crashed"
	fi
	
fi
}

function reset_vars { # set all variables to NA to resolve issues in console output 
NA="?"

METH="$NA" 
BASIS="$NA" 
ENERG_EL="$NA" 
ZPVE="$NA" 
ENERG_THERM="$NA" 
ENTHALPY="$NA" 
GIBBS="$NA" 
IMAG="$NA" 
NTERM="$NA" 
PROG="$NA" 
REV="$NA" 
RUNTIME="$NA" 
NTERM="$NA" 
IMAG="$NA" 
}



######################################################
# initialisation of the *.csv files

echo "summary" > $CSVFILEFILEPATH #
echo "user;$USERFILEPATH" >> $CSVFILEFILEPATH
echo "directory;$DIR" >> $CSVFILEFILEPATH
echo "host;$HOST" >> $CSVFILEFILEPATH
echo "host IP;$HOSTIP" >> $CSVFILEFILEPATH

echo " " >> $CSVFILEFILEPATH

TABLEHEAD="Filepath;filename;method; basisset; E(el); ZP corr.; E corr.; H corr.; G corr.; imaginary frequencies; Normal terminations; programm; Revison; Runtime; Notes"

echo "$TABLEHEAD" >> $CSVFILEFILEPATH

######################################################


#table headers for console output
case $VERBOSITY in
	0)
	echo "      FILEPATH            |  E(SCF)/ AU    |  ZP      | G(korr)   |NT |IF |Program   |   notes"
	echo "--------------------------+----------------+----------+-----------+---+---+----------+----------- "
	#     1_PBE0_D3_def2SVp.out     | -1957.21230414 | 0.303797 | -0.335047 | 2 | 0 | Gaussian |
	;;
	1)
	echo "$FULLPATH $FILENAME $METH $BASIS $ENERG_EL $ZPVE $ENERG_THERM $ENTHALPY $GIBBS $IMAG $NTERM $PROG $REV $RUNTIME"
	;;
esac




# actuale magic happens here
for FILEPATH in "${LISTARR[@]}" ; do

NOTES=""

reset_vars


ident_prog
format_strings
find_methode
find_energ
find_ther_corr
find_Nimag
find_NTerm
find_version
find_runtime
#FILEPATH=`echo $FILEPATH | sed -e 's/\.//g' `



#console output
case $VERBOSITY in
	0)
	ENERG_EL_FORM=`echo "$ENERG_EL" | cut -c -14 `
	printf '%-25s | %-10s | %-8s | %-9s | %-1s | %-1s | %-8s | %-30s \n' $FILENAMFORMATTED $ENERG_EL_FORM $ZPVE $GIBBS $NTERM $IMAG $PROGNAME $NOTES | sed 's/ / /g'
	;;
	1)
	echo "$FILEPATH $METH $BASIS $ENERG_EL $ZPVE $ENERG_THERM $ENTHALPY $GIBBS $IMAG $NTERM $PROG $REV $RUNTIME"
	;;
esac

# CSV Output

echo "$FULLPATH;$FILENAME;$METH;$BASIS;$ENERG_EL;$ZPVE;$ENERG_THERM;$ENTHALPY;$GIBBS;$IMAG;$NTERM;$PROG;$REV;$RUNTIME;$NOTES" >> $CSVFILEFILEPATH

done

######################################################
#post processing of the csv file
#change the CSV delimiter


if [ "$CSVDELIM" != ";" ]
then
	cp $CSVFILEFILEPATH $CSVFILEFILEPATH_BKUP
	awk '$1=$1' FS=";" OFS="$CSVDELIM" $CSVFILEFILEPATH_BKUP > $CSVFILEFILEPATH
fi

#change the decimal seperator

if [ "DECISEP" != "." ]
then
	cp $CSVFILEFILEPATH $CSVFILEFILEPATH_BKUP
	sed "s/\./$DECISEP/g" $CSVFILEFILEPATH_BKUP > $CSVFILEFILEPATH
	#awk '$1=$1' FS=";" OFS="$CSVDELIM" $CSVFILEFILEPATH_BKUP > $CSVFILEFILEPATH
fi







